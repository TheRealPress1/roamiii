

# Fix Login UX: Persistent Sessions + One-Click Google Sign In + Smart Redirects

This plan transforms the authentication experience from "email → wait for link" to a seamless one-click Google OAuth flow while keeping magic links as a fallback.

---

## Current State Analysis

**What's already working:**
- Supabase client is correctly configured with `persistSession: true` and `autoRefreshToken: true`
- `AuthContext` properly listens to `onAuthStateChange` and calls `getSession()` on load
- Auth page already redirects logged-in users to `/app`

**What needs improvement:**
- Landing page buttons always navigate to `/auth` without checking existing session
- Header "Log in" button doesn't check session before navigating
- Only magic link auth is available (slow, friction-heavy)
- No Google OAuth option for one-click sign-in

---

## Implementation Plan

### 1. Configure Google OAuth

Use Lovable Cloud's managed Google OAuth (automatically configured, no credentials needed).

**Tool call:** `supabase--configure-social-auth` with `google` provider

This will:
- Generate the lovable module in `src/integrations/lovable/`
- Install `@lovable.dev/cloud-auth-js` package
- Enable one-click Google sign-in

---

### 2. Update Auth Context

Add a new `signInWithGoogle` method to the `AuthContext`:

**File:** `src/contexts/AuthContext.tsx`

```typescript
interface AuthContextType {
  // ... existing
  signInWithGoogle: () => Promise<{ error: Error | null }>;
}

const signInWithGoogle = async () => {
  const { lovable } = await import('@/integrations/lovable');
  const { error } = await lovable.auth.signInWithOAuth('google', {
    redirect_uri: window.location.origin,
  });
  return { error: error as Error | null };
};
```

---

### 3. Update Auth Page UI

**File:** `src/pages/Auth.tsx`

Transform the auth UI to prioritize Google OAuth:

```
┌─────────────────────────────────────────────────────┐
│                                                     │
│                    [TripChat Logo]                  │
│                                                     │
│                     Sign in                         │
│         One click with Google, or use email.        │
│                                                     │
│  ┌───────────────────────────────────────────────┐  │
│  │  [G]  Continue with Google                    │  │  ← Primary (blue/gradient)
│  └───────────────────────────────────────────────┘  │
│                                                     │
│  ────────────── or ──────────────                   │
│                                                     │
│  ┌───────────────────────────────────────────────┐  │
│  │  [✉]  Continue with Email                     │  │  ← Secondary (outline)
│  └───────────────────────────────────────────────┘  │
│                                                     │
│  We'll email you a secure sign-in link.             │
│                                                     │
└─────────────────────────────────────────────────────┘
```

**Key changes:**
- New headline: "Sign in" (simpler, unified)
- New subtext: "One click with Google, or use email."
- Primary button: "Continue with Google" (gradient style)
- Divider: "or"
- Secondary button: "Continue with Email" (outline style)
- Email form only appears after clicking "Continue with Email"

---

### 4. Smart Redirects on Landing Page

**File:** `src/pages/Landing.tsx`

Replace static `<Link>` components with smart navigation that checks session first:

```typescript
import { useAuth } from '@/contexts/AuthContext';
import { useNavigate } from 'react-router-dom';

// In component:
const { user, loading } = useAuth();
const navigate = useNavigate();

const handleSignIn = () => {
  if (user) {
    navigate('/app');
  } else {
    navigate('/auth');
  }
};

const handleGetStarted = () => {
  if (user) {
    navigate('/app');
  } else {
    navigate('/auth?mode=signup');
  }
};
```

Replace:
```jsx
<Link to="/auth?mode=signup">
  <Button>Create a Trip</Button>
</Link>
```

With:
```jsx
<Button onClick={handleGetStarted}>Create a Trip</Button>
```

---

### 5. Smart Redirects in Header

**File:** `src/components/layout/Header.tsx`

The header already shows different UI for logged-in vs logged-out users, but we should add smart navigation:

```typescript
const handleLogin = () => {
  if (user) {
    navigate('/app');
  } else {
    navigate('/auth');
  }
};
```

Replace the static `<Link to="/auth">` with an `onClick` handler.

---

## File Changes Summary

| File | Action | Description |
|------|--------|-------------|
| `src/integrations/lovable/` | Create | Generated by configure-social-auth tool |
| `src/contexts/AuthContext.tsx` | Update | Add `signInWithGoogle` method |
| `src/pages/Auth.tsx` | Update | Add Google OAuth button, reorganize UI |
| `src/pages/Landing.tsx` | Update | Smart navigation checking session |
| `src/components/layout/Header.tsx` | Update | Smart navigation for login button |

---

## User Flow After Implementation

**Returning user (already logged in):**
1. Visits landing page
2. Clicks "Sign In" → Goes directly to `/app` (no auth screen)

**New user:**
1. Visits landing page
2. Clicks "Get Started" → Goes to `/auth`
3. Clicks "Continue with Google" → One-click OAuth
4. Lands in `/app`

**User preferring email:**
1. On `/auth` page, clicks "Continue with Email"
2. Email form appears
3. Enters email, receives magic link
4. Clicks link, lands in `/app`

---

## Session Persistence Verification

The Supabase client is already configured correctly:
```typescript
auth: {
  storage: localStorage,
  persistSession: true,
  autoRefreshToken: true,
}
```

After this implementation:
- Session survives page refresh
- Session survives browser restart
- Session survives tab close/reopen
- Only explicit "Sign out" clears session

